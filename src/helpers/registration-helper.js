export const COUNTRY_INCOME_GROUPS = {
  // LOW / LOWER-MIDDLE INCOME ECONOMIES
  "Afghanistan": "LOWER",
  "Korea, Dem. People's Rep": "LOWER",
  "Somalia": "LOWER",
  "Burkina Faso": "LOWER",
  "Liberia": "LOWER",
  "South Sudan": "LOWER",
  "Burundi": "LOWER",
  "Madagascar": "LOWER",
  "Sudan": "LOWER",
  "Central African Republic": "LOWER",
  "Malawi": "LOWER",
  "Syrian Arab Republic": "LOWER",
  "Chad": "LOWER",
  "Mali": "LOWER",
  "Togo": "LOWER",
  "Congo, Dem. Rep": "LOWER",
  "Mozambique": "LOWER",
  "Uganda": "LOWER",
  "Eritrea": "LOWER",
  "Niger": "LOWER",
  "Yemen, Rep.": "LOWER",
  "Gambia, The": "LOWER",
  "Rwanda": "LOWER",
  "Guinea-Bissau": "LOWER",
  "Sierra Leone": "LOWER",

  "Angola": "LOWER",
  "India": "LOWER",
  "Papua New Guinea": "LOWER",
  "Bangladesh": "LOWER",
  "Jordan": "LOWER",
  "Philippines": "LOWER",
  "Benin": "LOWER",
  "Kenya": "LOWER",
  "São Tomé and Principe": "LOWER",
  "Bhutan": "LOWER",
  "Kiribati": "LOWER",
  "Senegal": "LOWER",
  "Bolivia": "LOWER",
  "Kyrgyz Republic": "LOWER",
  "Solomon Islands": "LOWER",
  "Cambodia": "LOWER",
  "Lao PDR": "LOWER",

  /* ★ UPDATED:
     Sri Lanka must ALWAYS use LOCAL pricing,
     but we keep its income group here because the override happens later.
  */
  "Sri Lanka": "LOWER",

  "Cameroon": "LOWER",
  "Lebanon": "LOWER",
  "Tajikistan": "LOWER",
  "Comoros": "LOWER",
  "Lesotho": "LOWER",
  "Tanzania": "LOWER",
  "Congo, Rep.": "LOWER",
  "Mauritania": "LOWER",
  "Timor-Leste": "LOWER",
  "Côte d'Ivoire": "LOWER",
  "Micronesia, Fed. Sts.": "LOWER",
  "Tunisia": "LOWER",
  "Djibouti": "LOWER",
  "Morocco": "LOWER",
  "Uzbekistan": "LOWER",
  "Egypt, Arab Rep.": "LOWER",
  "Myanmar": "LOWER",
  "Vanuatu": "LOWER",
  "Eswatini": "LOWER",
  "Namibia": "LOWER",
  "Viet Nam": "LOWER",
  "Ghana": "LOWER",
  "Nepal": "LOWER",
  "West Bank and Gaza": "LOWER",
  "Guinea": "LOWER",
  "Nicaragua": "LOWER",
  "Zambia": "LOWER",
  "Haiti": "LOWER",
  "Nigeria": "LOWER",
  "Zimbabwe": "LOWER",
  "Honduras": "LOWER",
  "Pakistan": "LOWER",

  // UPPER-MIDDLE / HIGH INCOME ECONOMIES
  "Albania": "UPPER",
  "Equatorial Guinea": "UPPER",
  "Moldova": "UPPER",
  "Algeria": "UPPER",
  "Fiji": "UPPER",
  "Mongolia": "UPPER",
  "Argentina": "UPPER",
  "Gabon": "UPPER",
  "Montenegro": "UPPER",
  "Armenia": "UPPER",
  "Georgia": "UPPER",
  "North Macedonia": "UPPER",
  "Azerbaijan": "UPPER",
  "Grenada": "UPPER",
  "Paraguay": "UPPER",
  "Belarus": "UPPER",
  "Guatemala": "UPPER",
  "Peru": "UPPER",
  "Belize": "UPPER",
  "Indonesia": "UPPER",
  "Samoa": "UPPER",
  "Bosnia and Herzegovina": "UPPER",
  "Iran, Islamic Rep.": "UPPER",
  "Serbia": "UPPER",
  "Botswana": "UPPER",
  "Iraq": "UPPER",
  "South Africa": "UPPER",
  "Brazil": "UPPER",
  "Jamaica": "UPPER",
  "St. Lucia": "UPPER",
  "Cabo Verde": "UPPER",
  "Kazakhstan": "UPPER",
  "St. Vincent and the Grenadines": "UPPER",
  "China": "UPPER",
  "Kosovo": "UPPER",
  "Suriname": "UPPER",
  "Colombia": "UPPER",
  "Libya": "UPPER",
  "Thailand": "UPPER",
  "Cuba": "UPPER",
  "Malaysia": "UPPER",
  "Tonga": "UPPER",
  "Dominica": "UPPER",
  "Maldives": "UPPER",
  "Türkiye": "UPPER",
  "Dominican Republic": "UPPER",
  "Marshall Islands": "UPPER",
  "Turkmenistan": "UPPER",
  "Ecuador": "UPPER",
  "Mauritius": "UPPER",
  "Tuvalu": "UPPER",
  "El Salvador": "UPPER",
  "Mexico": "UPPER",
  "Ukraine": "UPPER",

  "American Samoa": "UPPER",
  "Gibraltar": "UPPER",
  "Panama": "UPPER",
  "Andorra": "UPPER",
  "Greece": "UPPER",
  "Poland": "UPPER",
  "Antigua and Barbuda": "UPPER",
  "Greenland": "UPPER",
  "Portugal": "UPPER",
  "Aruba": "UPPER",
  "Guam": "UPPER",
  "Puerto Rico": "UPPER",
  "Australia": "UPPER",
  "Guyana": "UPPER",
  "Qatar": "UPPER",
  "Austria": "UPPER",
  "Hong Kong SAR, China": "UPPER",
  "Romania": "UPPER",
  "Bahamas, The": "UPPER",
  "Hungary": "UPPER",
  "Russian Federation": "UPPER",
  "Bahrain": "UPPER",
  "Iceland": "UPPER",
  "San Marino": "UPPER",
  "Barbados": "UPPER",
  "Ireland": "UPPER",
  "Saudi Arabia": "UPPER",
  "Belgium": "UPPER",
  "Isle of Man": "UPPER",
  "Seychelles": "UPPER",
  "Bermuda": "UPPER",
  "Israel": "UPPER",
  "Singapore": "UPPER",
  "British Virgin Islands": "UPPER",
  "Italy": "UPPER",
  "Sint Maarten (Dutch part)": "UPPER",
  "Brunei Darussalam": "UPPER",
  "Japan": "UPPER",
  "Slovak Republic": "UPPER",
  "Bulgaria": "UPPER",
  "Korea, Rep.": "UPPER",
  "Slovenia": "UPPER",
  "Canada": "UPPER",
  "Kuwait": "UPPER",
  "Spain": "UPPER",
  "Cayman Islands": "UPPER",
  "Latvia": "UPPER",
  "St. Kitts and Nevis": "UPPER",
  "Channel Islands": "UPPER",
  "Liechtenstein": "UPPER",
  "St. Martin (French part)": "UPPER",
  "Chile": "UPPER",
  "Lithuania": "UPPER",
  "Sweden": "UPPER",
  "Costa Rica": "UPPER",
  "Luxembourg": "UPPER",
  "Switzerland": "UPPER",
  "Croatia": "UPPER",
  "Macao SAR, China": "UPPER",
  "Taiwan, China": "UPPER",
  "Curaçao": "UPPER",
  "Malta": "UPPER",
  "Trinidad and Tobago": "UPPER",
  "Cyprus": "UPPER",
  "Monaco": "UPPER",
  "Turks and Caicos Islands": "UPPER",
  "Czechia": "UPPER",
  "Nauru": "UPPER",
  "United Arab Emirates": "UPPER",
  "Denmark": "UPPER",
  "Netherlands": "UPPER",
  "United Kingdom": "UPPER",
  "Estonia": "UPPER",
  "New Caledonia": "UPPER",
  "United States": "UPPER",
  "Faroe Islands": "UPPER",
  "New Zealand": "UPPER",
  "Uruguay": "UPPER",
  "Finland": "UPPER",
  "Northern Mariana Islands": "UPPER",
  "Virgin Islands (U.S.)": "UPPER",
  "France": "UPPER",
  "Norway": "UPPER",
  "French Polynesia": "UPPER",
  "Oman": "UPPER",
  "Germany": "UPPER",
  "Palau": "UPPER"
};

export function getFeePeriod() {
  const today = new Date();
  const earlyEnd = new Date("2026-09-30T23:59:59Z");
  return today <= earlyEnd ? "early" : "late";
}

export function determineIncomeGroup(country, rawGroup) {
  if (country === "Sri Lanka") return "LOCAL";
  return rawGroup;
}

export const FEE_RULES = {
  full: {
    LOWER: {
      physician: { early: 100, late: 150 },
      'non-physician': { early: 50, late: 75 },
    },
    UPPER: {
      physician: { early: 250, late: 300 },
      'non-physician': { early: 100, late: 150 },
    },
    LOCAL: {
      physician: { early: 30, late: 50 },
      'non-physician': { early: 20, late: 30 },
    },
  },
  rehab: {
    ALL: { early: 15, late: 40 },
  },
};

export function calculateFee({ conferenceType, participantCategory, incomeGroup }) {
  const period = getFeePeriod();

  if (conferenceType === "rehab") {
    return {
      amount: FEE_RULES.rehab.ALL[period],
      period
    };
  }

  const table = FEE_RULES.full[incomeGroup];
  if (!table) return null;

  return {
    amount: table[participantCategory][period],
    period
  };
}

export function requireFields(body, fields = []) {
  const missing = fields.filter(f => !body[f]);
  if (missing.length) {
    throw new Error(`Missing required fields: ${missing.join(", ")}`);
  }
}

export function generateRandomId() {
  const alphabet = "ABCDEFGHJKMNPQRSTUVWXYZ23456789"; // no ambiguous chars
  let id = "";
  for (let i = 0; i < 8; i++) {
    id += alphabet.charAt(Math.floor(Math.random() * alphabet.length));
  }
  return id;
}

/**
 * Strips fields that should be server-controlled.
 * Keep this strict so clients cannot tamper with pricing/payment.
 */
export function sanitizeRegistrationUpdates(updates = {}) {
  const disallowed = new Set([
    "registrationId",
    "incomeGroup",
    "feeAmount",
    "feePeriod",
    "feeBreakdown",
    "paymentStatus",
    "paymentReference",
    "paymentProvider",
    "createdAt",
    "updatedAt",
    "__v",
    "_id",
  ]);

  const safe = {};
  for (const [key, value] of Object.entries(updates)) {
    if (disallowed.has(key)) continue;
    safe[key] = value;
  }
  return safe;
}